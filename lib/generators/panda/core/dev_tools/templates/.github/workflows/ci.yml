---
name: "CI"

"on": # yamllint disable-line rule:truthy
  pull_request:
  push:
    branches:
      - main
  merge_group:
    types: [checks_requested]

jobs:
  lint:
    name: "Linters"
    runs-on: "ubuntu-latest"
    env:
      BUNDLE_PATH: "vendor/bundle"
    steps:
      - uses: "actions/checkout@v4"
      - uses: "ruby/setup-ruby@v1"
        with:
          bundler-cache: true
      - name: "Bundler Audit"
        run: "bundle exec bundle-audit --update"
      - name: "Brakeman"
        run: "bundle exec brakeman --quiet"
      - name: "StandardRB Check"
        run: "bundle exec standardrb"
      - name: "YAML Lint"
        run: "yamllint -c .yamllint ."

  test:
    name: "Tests"
    runs-on: "ubuntu-latest"
    env:
      BUNDLE_PATH: "vendor/bundle"
      RAILS_ENV: test
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        ports: ["5432:5432"]
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: "actions/checkout@v4"
      - name: "Setup Ruby"
        uses: "ruby/setup-ruby@v1"
        with:
          bundler-cache: true

      - name: "Setup test environment"
        env:
          DATABASE_URL: "postgres://postgres:password@localhost:5432/test"
          RAILS_ENV: "test"
          PG_USER: "postgres"
        run: |
          cd spec/dummy
          bundle exec rails db:create
          bundle exec rails db:schema:load

      - name: "Run specs"
        env:
          DATABASE_URL: "postgres://postgres:password@localhost:5432/test"
          RAILS_ENV: "test"
        run: |
          bundle exec rspec

      - name: "Upload coverage"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage
          path: coverage/