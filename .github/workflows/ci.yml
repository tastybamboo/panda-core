---
name: 'App Tests'

'on': # yamllint disable-line rule:truthy
  pull_request:
  push:
    branches:
      - main
  merge_group:
    types: [checks_requested]

jobs:
  # Run latest version first as a smoke test
  # This ensures basic functionality works before testing older versions
  smoke-test:
    name: 'üöÄ Latest (Rails 8.1.1, Ruby 3.4, PostgreSQL)'
    runs-on: 'ubuntu-latest'

    container:
      image: ghcr.io/tastybamboo/panda-ci:ruby-3.4-rails-8.1.1
      options: --shm-size=2gb

    permissions:
      contents: read
      pull-requests: write
      checks: write

    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
      DISPLAY: ':99'
      RAILS_VERSION: '8.1.1'
      DATABASE_ADAPTER: 'postgresql'

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: 'actions/checkout@v5'

      - name: 'Update VERSION'
        env:
          VERSION: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "${VERSION}" >> VERSION

      - name: 'Start xvfb'
        run: |
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: 'Bundle install (main gem)'
        run: |
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Setup test database'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          echo "üóÑÔ∏è Setting up database..."
          bundle exec rails db:schema:load
          echo "‚úÖ Database ready"

      - name: Panda asset generation and verification
        uses: tastybamboo/panda-assets-verify-action@v1
        with:
          dummy_root: spec/dummy
          artifact_suffix: -latest

      - name: 'Run specs'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
        run: |
          bundle exec rspec --format documentation --color

      - name: 'Upload coverage'
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: coverage-latest
          path: coverage/

      - name: Upload Capybara assets
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: capybara-screenshots-latest
          path: spec/dummy/tmp/capybara/**/*
          if-no-files-found: ignore
