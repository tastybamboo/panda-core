---
name: 'App Tests'

'on': # yamllint disable-line rule:truthy
  pull_request:
  push:
    branches:
      - main
  merge_group:
    types: [checks_requested]

jobs:
  seclint:
    name: 'Security Checks & Linters'
    runs-on: 'ubuntu-latest'
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
    env:
      BUNDLE_PATH: 'vendor/bundle'
    steps:
      - uses: 'actions/checkout@v5'

      - name: Load gems from cache
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}

      - name: 'Bundle install'
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Bundler Audit'
        run: 'bundle exec bundle-audit --update && bundle exec bundle-audit check'
      - name: 'Brakeman'
        run: 'bundle exec brakeman --quiet'
      - name: 'StandardRB Check'
        run: 'bundle exec standardrb'
      - name: 'ERB Check'
        run: 'bundle exec erb_lint app/views --lint-all'
      - name: 'YAML Lint'
        run: 'yamllint -c .yamllint .'

  specs:
    name: 'App Specs'
    needs: seclint
    runs-on: 'ubuntu-latest'
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
      options: --shm-size=2gb
    permissions:
      contents: read
      pull-requests: write
    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
      DISPLAY: ':99'
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        # Set health checks to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: 'actions/checkout@v5'

      - name: 'Update VERSION'
        env:
          VERSION: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "${VERSION}" >> VERSION

      - name: 'Start xvfb'
        run: |
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Load gems from cache
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}

      - name: 'Bundle install'
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Cache assets'
        uses: actions/cache@v4
        with:
          path: |
            spec/dummy/public/panda-core-assets
            spec/dummy/tmp/cache/assets
          key: ${{ runner.os }}-assets-${{ hashFiles('app/assets/**/*', 'app/javascript/**/*') }}
          restore-keys: |
            ${{ runner.os }}-assets-

      - name: 'Setup test database'
        working-directory: spec/dummy
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          # Clean up ALL migrations in dummy app to start fresh
          rm -rf db/migrate
          mkdir -p db/migrate
          # Copy engine migrations to dummy app (required because engine disables migrations in test mode)
          cp ../../db/migrate/*.rb db/migrate/
          bundle exec rails db:drop db:create db:migrate

      - name: Prepare + verify dummy assets (Core + all modules)
        env:
          DATABASE_URL: postgres://postgres:password@postgres:5432/test
        run: |
          echo "ðŸš§ Preparing dummy assets (Core + modules)â€¦"
          bundle exec rake panda:assets:prepare_and_verify_all

      - name: 'Run specs'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
        run: |
          script -q -e -c "bundle exec rspec --format documentation --color" /dev/null

      - name: 'Upload coverage'
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: coverage
          path: coverage/

      - name: 'Upload always on failure'
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: capybara-screenshots
          path: spec/dummy/tmp/capybara/**/*
          if-no-files-found: ignore

      - name: Upload asset verification report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: panda-assets-report
          path: spec/dummy/tmp/panda_assets_report.html
          retention-days: 7
