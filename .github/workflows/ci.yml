---
name: 'App Tests'

'on': # yamllint disable-line rule:truthy
  pull_request:
  push:
    branches:
      - main
  merge_group:
    types: [checks_requested]

jobs:
  seclint:
    name: 'Security Checks & Linters'
    runs-on: 'ubuntu-latest'
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
    env:
      BUNDLE_PATH: 'vendor/bundle'
    steps:
      - uses: 'actions/checkout@v6'

      - name: Load gems from cache
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}

      - name: 'Bundle install'
        run: |
          bundle config path vendor/bundle
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Bundler Audit'
        run: 'bundle exec bundle-audit --update && bundle exec bundle-audit check'
      - name: 'Brakeman'
        run: 'bundle exec brakeman --quiet'
      - name: 'StandardRB Check'
        run: 'bundle exec standardrb'
      - name: 'ERB Check'
        run: 'bundle exec erb_lint app/views --lint-all'
      - name: 'YAML Lint'
        run: 'yamllint -c .yamllint .'

  # Run latest version first as a smoke test
  # This ensures basic functionality works before testing older versions
  smoke-test:
    name: 'üöÄ Latest (Rails 8.1.1, Ruby 3.4, PostgreSQL 18)'
    needs: seclint
    runs-on: 'ubuntu-latest'

    container:
      image: ghcr.io/tastybamboo/panda-ci:ruby-3.4-rails-8.1.1
      options: --shm-size=2gb

    permissions:
      contents: read
      pull-requests: write
      checks: write

    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
      DISPLAY: ':99'
      RAILS_VERSION: '8.1.1'
      DATABASE_ADAPTER: 'postgresql'

    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: 'actions/checkout@v6'

      - name: 'Update VERSION'
        env:
          VERSION: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "${VERSION}" >> VERSION

      - name: 'Start xvfb'
        run: |
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: 'Bundle install (main gem)'
        run: |
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Setup test database'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          echo "üóÑÔ∏è Setting up database..."
          bundle exec rails db:schema:load
          echo "‚úÖ Database ready"

      - name: Panda asset generation and verification
        uses: tastybamboo/panda-assets-verify-action@v1
        with:
          dummy_root: spec/dummy
          artifact_suffix: -latest

      - name: 'Run specs'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
        run: |
          bundle exec rspec --format documentation --color

      - name: 'Upload coverage'
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: coverage-latest
          path: coverage/

      - name: Upload Capybara assets
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: capybara-screenshots-latest
          path: spec/dummy/tmp/capybara/**/*
          if-no-files-found: ignore

  # Full matrix tests - only run if smoke test passes
  compatibility-matrix-postgresql:
    name: 'PostgreSQL ${{ matrix.postgres }} (Rails ${{ matrix.rails }}, Ruby ${{ matrix.ruby }})'
    needs: smoke-test # Gate on smoke test success
    runs-on: 'ubuntu-latest'
    continue-on-error: ${{ matrix.experimental == true }} # Allow experimental to fail

    strategy:
      fail-fast: false
      max-parallel: 10 # Limit parallel jobs to avoid overwhelming CI
      matrix:
        ruby: ['3.2', '3.3', '3.4']
        rails: ['7.0.10', '7.1.6', '7.2.3', '8.0.4', '8.1.1']
        postgres: ['18'] # Default to PostgreSQL 18 for all combinations
        experimental: [false]

        # Add any experimental/beta versions here  # yamllint disable-line rule:comments-indentation
        # include:
        #   - ruby: '3.5'
        #     rails: '8.2.0'
        #     experimental: true

        # Test older PostgreSQL versions with representative Ruby/Rails combinations
        include:
          # PostgreSQL 12 with Ruby 3.2 and Rails 7.1 (LTS)
          - ruby: '3.2'
            rails: '7.1.6'
            postgres: '12'
            experimental: false

          # PostgreSQL 15 with Ruby 3.3 and Rails 7.2
          - ruby: '3.3'
            rails: '7.2.3'
            postgres: '15'
            experimental: false

          # PostgreSQL 17 with Ruby 3.4 and Rails 8.0
          - ruby: '3.4'
            rails: '8.0.4'
            postgres: '17'
            experimental: false

        exclude:
          # Rails 7.0 is not compatible with Ruby 3.4
          - ruby: '3.4'
            rails: '7.0.10'
            postgres: '18'

          # Skip the combination already tested in smoke-test
          - ruby: '3.4'
            rails: '8.1.1'
            postgres: '18'

    container:
      image: ghcr.io/tastybamboo/panda-ci:ruby-${{ matrix.ruby }}-rails-${{ matrix.rails }}
      options: --shm-size=2gb

    permissions:
      contents: read
      pull-requests: write
      checks: write

    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
      DISPLAY: ':99'
      RAILS_VERSION: ${{ matrix.rails }}
      DATABASE_ADAPTER: 'postgresql'

    services:
      postgres:
        image: postgres:${{ matrix.postgres }}
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: 'actions/checkout@v6'

      - name: 'Update VERSION'
        env:
          VERSION: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "${VERSION}" >> VERSION

      - name: 'Start xvfb'
        run: |
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      # Since Docker images have gems pre-installed, we only need minimal setup
      - name: 'Bundle install (main gem)'
        run: |
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Setup test database'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: test
        run: |
          echo "üóÑÔ∏è Setting up database..."
          bundle exec rails db:schema:load
          echo "‚úÖ Database ready"

      #
      # üêº Run Panda Asset Verification
      #
      - name: Panda asset generation and verification
        uses: tastybamboo/panda-assets-verify-action@v1
        with:
          dummy_root: spec/dummy
          artifact_suffix: -ruby-${{ matrix.ruby }}-rails-${{ matrix.rails }}-postgresql-${{ matrix.postgres }}

      #
      # üß™ Run application tests
      #
      - name: 'Run specs'
        env:
          DATABASE_URL: 'postgres://postgres:password@postgres:5432/test'
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
        run: |
          bundle exec rspec --format documentation --color

      - name: 'Upload coverage'
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: coverage-${{ matrix.ruby }}-${{ matrix.rails }}-postgresql-${{ matrix.postgres }}
          path: coverage/

      - name: Upload Capybara assets
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: capybara-${{ matrix.ruby }}-${{ matrix.rails }}-postgresql-${{ matrix.postgres }}
          path: spec/dummy/tmp/capybara/**/*
          if-no-files-found: ignore

  # SQLite compatibility matrix
  compatibility-matrix-sqlite:
    name: 'SQLite (Rails ${{ matrix.rails }}, Ruby ${{ matrix.ruby }})'
    needs: smoke-test
    runs-on: 'ubuntu-latest'
    continue-on-error: ${{ matrix.experimental == true }}

    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        ruby: ['3.2', '3.3', '3.4']
        rails: ['7.0.10', '7.1.6', '7.2.3', '8.0.4', '8.1.1']
        experimental: [false]

        exclude:
          # Rails 7.0 is not compatible with Ruby 3.4
          - ruby: '3.4'
            rails: '7.0.10'

    container:
      image: ghcr.io/tastybamboo/panda-ci:ruby-${{ matrix.ruby }}-rails-${{ matrix.rails }}
      options: --shm-size=2gb

    permissions:
      contents: read
      pull-requests: write
      checks: write

    env:
      BUNDLE_PATH: 'vendor/bundle'
      RAILS_ENV: test
      DISPLAY: ':99'
      RAILS_VERSION: ${{ matrix.rails }}
      DATABASE_ADAPTER: 'sqlite'

    steps:
      - uses: 'actions/checkout@v5'

      - name: 'Update VERSION'
        env:
          VERSION: ${{ github.event.pull_request.head.sha }}
        run: |
          echo "${VERSION}" >> VERSION

      - name: 'Start xvfb'
        run: |
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: 'Bundle install (main gem)'
        run: |
          bundle config without development
          bundle install --jobs 4 --retry 3

      - name: 'Setup test database'
        env:
          RAILS_ENV: test
        run: |
          echo "üóÑÔ∏è Setting up SQLite database..."
          bundle exec rails db:migrate
          echo "‚úÖ Database ready"

      - name: Panda asset generation and verification
        uses: tastybamboo/panda-assets-verify-action@v1
        with:
          dummy_root: spec/dummy
          artifact_suffix: -ruby-${{ matrix.ruby }}-rails-${{ matrix.rails }}-sqlite

      - name: 'Run specs'
        env:
          RAILS_ENV: 'test'
          RSPEC_COLOR: 'true'
          TERM: 'xterm-256color'
        run: |
          bundle exec rspec --format documentation --color

      - name: 'Upload coverage'
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: coverage-${{ matrix.ruby }}-${{ matrix.rails }}-sqlite
          path: coverage/

      - name: Upload Capybara assets
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: capybara-${{ matrix.ruby }}-${{ matrix.rails }}-sqlite
          path: spec/dummy/tmp/capybara/**/*
          if-no-files-found: ignore

  # Summary job to ensure all tests passed
  matrix-summary:
    name: 'Matrix Tests Summary'
    needs: [smoke-test, compatibility-matrix-postgresql, compatibility-matrix-sqlite]
    runs-on: 'ubuntu-latest'
    if: always()
    steps:
      - name: Check matrix results
        run: |
          if [[ "${{ needs.smoke-test.result }}" != "success" ]]; then
            echo "‚ùå Smoke test failed"
            exit 1
          fi

          if [[ "${{ needs.compatibility-matrix-postgresql.result }}" == "failure" ]]; then
            echo "‚ùå Some PostgreSQL compatibility tests failed"
            exit 1
          fi

          if [[ "${{ needs.compatibility-matrix-sqlite.result }}" == "failure" ]]; then
            echo "‚ùå Some SQLite compatibility tests failed"
            exit 1
          fi

          echo "‚úÖ All required tests passed!"
