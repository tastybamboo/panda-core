---
name: CI

on:  # yamllint disable-line rule:truthy
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-stable:
    name: Test (stable)
    runs-on: ubuntu-latest
    outputs:
      has_flaky_tests: ${{ steps.check-flaky.outputs.has_flaky }}
    container:
      image: ghcr.io/tastybamboo/panda-ci:ruby-4.0.1
    env:
      BUNDLE_PATH: vendor/bundle
      RAILS_ENV: test
      DISPLAY: :99
      CUPRITE_TIMEOUT: "30"
      CUPRITE_PROCESS_TIMEOUT: "180"
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - name: Check for flaky tests
        id: check-flaky
        run: |
          if grep -rq "flaky: true\|:flaky\b" spec/; then
            echo "has_flaky=true" >> $GITHUB_OUTPUT
          else
            echo "has_flaky=false" >> $GITHUB_OUTPUT
          fi

      - name: Start Xvfb
        run: |
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Cache gems
        uses: actions/cache@v5
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-stable-${{ hashFiles('Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-stable-
            ${{ runner.os }}-gems-

      - name: Bundle install
        run: |
          bundle config path vendor/bundle
          bundle install --jobs 4 --retry 3

      - name: Setup database
        env:
          DATABASE_URL: postgres://postgres:password@postgres:5432/test
        run: bundle exec rails db:create db:schema:load

      - name: Run stable tests
        env:
          DATABASE_URL: postgres://postgres:password@postgres:5432/test
        run: bundle exec rspec --tag ~flaky --format progress --color

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: cuprite-failures-stable
          path: |
            tmp/cuprite_failures/**
            tmp/capybara/**
            spec/dummy/tmp/cuprite_failures/**
            spec/dummy/tmp/capybara/**
          if-no-files-found: ignore

  test-flaky:
    name: Test (flaky)
    needs: test-stable
    if: needs.test-stable.outputs.has_flaky_tests == 'true'
    runs-on: ubuntu-latest
    continue-on-error: true
    container:
      image: ghcr.io/tastybamboo/panda-ci:ruby-4.0.1
    env:
      BUNDLE_PATH: vendor/bundle
      RAILS_ENV: test
      DISPLAY: :99
      CUPRITE_TIMEOUT: "30"
      CUPRITE_PROCESS_TIMEOUT: "180"
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6

      - name: Start Xvfb
        run: |
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &

      - name: Cache gems
        uses: actions/cache@v5
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-flaky-${{ hashFiles('Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-flaky-
            ${{ runner.os }}-gems-

      - name: Bundle install
        run: |
          bundle config path vendor/bundle
          bundle install --jobs 4 --retry 3

      - name: Setup database
        env:
          DATABASE_URL: postgres://postgres:password@postgres:5432/test
        run: bundle exec rails db:create db:schema:load

      - name: Run flaky tests
        env:
          DATABASE_URL: postgres://postgres:password@postgres:5432/test
        run: bundle exec rspec --tag flaky --format progress --color || true

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: cuprite-failures-flaky
          path: |
            tmp/cuprite_failures/**
            tmp/capybara/**
            spec/dummy/tmp/cuprite_failures/**
            spec/dummy/tmp/capybara/**
          if-no-files-found: ignore

  lint:
    name: Linters
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/tastybamboo/panda-ci:latest
    env:
      BUNDLE_PATH: vendor/bundle
    steps:
      - uses: actions/checkout@v6

      - name: Cache gems
        uses: actions/cache@v5
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-lint-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-lint-
            ${{ runner.os }}-gems-

      - name: Bundle install
        run: |
          bundle config path vendor/bundle
          bundle install --jobs 4 --retry 3

      - name: Run StandardRB
        run: bundle exec standardrb

      - name: Run ERB Lint
        run: |
          if [ -f ".erb-lint.yml" ]; then
            bundle exec erb_lint app/views --lint-all
          else
            echo "No .erb-lint.yml found, skipping ERB lint"
          fi

      - name: Run Brakeman
        run: bundle exec brakeman --quiet --skip-files app/javascript/

      - name: Run bundle-audit
        run: |
          bundle exec bundle-audit update
          bundle exec bundle-audit check

      - name: Run YAML lint
        run: yamllint -c .yamllint .
