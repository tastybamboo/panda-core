---
name: "Compile and Commit Assets"

"on": # yamllint disable-line rule:truthy
  push:
    branches: [main]
    paths:
      - "app/assets/**/*"
      - "app/javascript/**/*"
      - "app/views/**/*"
      - "app/components/**/*"
      - "lib/panda/core/version.rb"
  workflow_dispatch:

jobs:
  compile-assets:
    name: "Compile CSS Assets"
    runs-on: "ubuntu-latest"
    permissions:
      contents: write # Needed to commit back to repo
    steps:
      - uses: "actions/checkout@v5"
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Setup Ruby"
        uses: "ruby/setup-ruby@v1"
        with:
          ruby-version: 3.3
          bundler-cache: true

      - name: "Get version"
        id: version
        run: |
          VERSION=$(ruby -r ./lib/panda/core/version.rb -e 'puts Panda::Core::VERSION')
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Compiling CSS for panda-core v${VERSION}"

      - name: "Compile CSS"
        run: |
          # Install tailwindcss standalone CLI
          curl -sLO https://github.com/tailwindlabs/tailwindcss/releases/latest/download/tailwindcss-linux-x64
          chmod +x tailwindcss-linux-x64

          echo "Compiling CSS for panda-core (Core files only)..."

          ./tailwindcss-linux-x64 \
            -i app/assets/tailwind/application.css \
            -o public/panda-core-assets/panda-core.css \
            --content './app/views/**/*.erb' \
            --content './app/components/**/*.rb' \
            --minify

          # Create versioned copy
          cp public/panda-core-assets/panda-core.css \
             public/panda-core-assets/panda-core-${{ steps.version.outputs.VERSION }}.css

          echo "âœ… CSS compilation complete"
          echo "CSS size: $(du -h public/panda-core-assets/panda-core.css | cut -f1)"

      - name: "List compiled assets"
        run: |
          echo "Compiled assets:"
          ls -lh public/panda-core-assets/

      - name: "Check for changes"
        id: changes
        run: |
          git add public/panda-core-assets/
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --staged --stat
          fi

      - name: "Commit and push changes"
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git commit -m "Auto-compile CSS for v${{ steps.version.outputs.VERSION }}

          CSS size: $(du -h public/panda-core-assets/panda-core.css | cut -f1)

          ðŸ¤– Generated by GitHub Actions"

          git push

          echo "âœ… CSS committed and pushed to main"

      - name: "Summary"
        run: |
          echo "## CSS Compilation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Compiled Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lh public/panda-core-assets/*.css >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.changed }}" == "true" ]; then
            echo "âœ… CSS compiled and committed to repository" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "CSS is available at:" >> $GITHUB_STEP_SUMMARY
            echo "- \`https://raw.githubusercontent.com/tastybamboo/panda-core/main/public/panda-core-assets/panda-core.css\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`https://raw.githubusercontent.com/tastybamboo/panda-core/main/public/panda-core-assets/panda-core-${{ steps.version.outputs.VERSION }}.css\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Note:** JavaScript uses importmap (no bundling needed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes detected (CSS already up to date)" >> $GITHUB_STEP_SUMMARY
          fi
