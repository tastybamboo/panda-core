#!/usr/bin/env ruby
# frozen_string_literal: true

require 'fileutils'
require 'pathname'

# Script to generate appropriate Gemfile for dummy app based on Rails version
# Usage: bin/setup-dummy-gemfile --rails-version 8.0.4 --dummy-path spec/dummy

class DummyGemfileGenerator
  RAILS_VERSION_CONFIGS = {
    '7.0' => {
      propshaft: '~> 0.6.4',
      importmap_rails: '~> 1.2',
      turbo_rails: '~> 1.5',
      stimulus_rails: '~> 1.3',
      sqlite3: '~> 1.4',
      pg: '~> 1.1',
      puma: '~> 5.6'
    },
    '7.1' => {
      propshaft: '~> 0.8.0',
      importmap_rails: '~> 1.2',
      turbo_rails: '~> 1.5',
      stimulus_rails: '~> 1.3',
      sqlite3: '~> 1.4',
      pg: '~> 1.1',
      puma: '~> 6.0'
    },
    '7.2' => {
      propshaft: '~> 0.9.0',
      importmap_rails: '~> 2.0',
      turbo_rails: '~> 2.0',
      stimulus_rails: '~> 1.3',
      sqlite3: '>= 1.4',
      pg: '~> 1.1',
      puma: '~> 6.0'
    },
    '8.0' => {
      propshaft: '~> 1.0.0',
      importmap_rails: '~> 2.0',
      turbo_rails: '~> 2.0',
      stimulus_rails: '~> 1.3',
      sqlite3: '>= 2.0',
      pg: '~> 1.5',
      puma: '>= 5.0'
    },
    '8.1' => {
      propshaft: '~> 1.1.0',
      importmap_rails: '~> 2.0',
      turbo_rails: '~> 2.0',
      stimulus_rails: '~> 1.3',
      sqlite3: '>= 2.0',
      pg: '~> 1.5',
      puma: '>= 5.0'
    }
  }.freeze

  def initialize(rails_version:, dummy_path:, parent_gem_path: nil, database: 'postgresql')
    @rails_version = rails_version
    @dummy_path = Pathname.new(dummy_path).expand_path
    @parent_gem_path = parent_gem_path || @dummy_path.parent.parent
    @database = database
  end

  def generate!
    gemfile_content = generate_gemfile
    gemfile_path = @dummy_path.join('Gemfile')

    # Create dummy directory if it doesn't exist
    FileUtils.mkdir_p(@dummy_path)

    # Write Gemfile
    File.write(gemfile_path, gemfile_content)
    puts "âœ… Generated Gemfile for Rails #{@rails_version} at #{gemfile_path}"

    # Also generate Gemfile.lock placeholder
    gemfile_lock_path = @dummy_path.join('Gemfile.lock')
    unless gemfile_lock_path.exist?
      File.write(gemfile_lock_path, "# This file will be generated by bundle install\n")
    end

    gemfile_path
  end

  private

  def rails_major_minor
    @rails_version.split('.')[0..1].join('.')
  end

  def gem_versions
    RAILS_VERSION_CONFIGS[rails_major_minor] || RAILS_VERSION_CONFIGS['8.0']
  end

  def generate_gemfile
    versions = gem_versions

    database_gem = case @database
    when 'sqlite', 'sqlite3'
      %(gem "sqlite3", "#{versions[:sqlite3]}")
    else # postgresql is default
      %(gem "pg", "#{versions[:pg]}")
    end

    <<~GEMFILE
      # frozen_string_literal: true
      # Generated by setup-dummy-gemfile for Rails #{@rails_version} with #{@database}

      source "https://rubygems.org"

      # Rails version
      gem "rails", "#{@rails_version}"

      # Asset pipeline essentials
      gem "propshaft", "#{versions[:propshaft]}"
      gem "importmap-rails", "#{versions[:importmap_rails]}"
      gem "turbo-rails", "#{versions[:turbo_rails]}"
      gem "stimulus-rails", "#{versions[:stimulus_rails]}"

      # Database adapter
      #{database_gem}

      # Web server
      gem "puma", "#{versions[:puma]}"

      # Add the parent gem being tested
      parent_gem_path = "#{@parent_gem_path}"
      parent_gemspec = Dir.glob(File.join(parent_gem_path, "*.gemspec")).first

      if parent_gemspec
        parent_gem_name = File.basename(parent_gemspec, ".gemspec")
        gem parent_gem_name, path: parent_gem_path
      end

      group :test do
        gem "debug", platforms: %i[mri windows]
      end
    GEMFILE
  end
end

# CLI handling
if __FILE__ == $0
  require 'optparse'

  options = {}

  OptionParser.new do |opts|
    opts.banner = "Usage: setup-dummy-gemfile [options]"

    opts.on("-r", "--rails-version VERSION", "Rails version (e.g., 8.0.4)") do |v|
      options[:rails_version] = v
    end

    opts.on("-d", "--dummy-path PATH", "Path to dummy app directory") do |p|
      options[:dummy_path] = p
    end

    opts.on("-p", "--parent-path PATH", "Path to parent gem (optional)") do |p|
      options[:parent_gem_path] = p
    end

    opts.on("-b", "--database DATABASE", "Database adapter: postgresql (default) or sqlite") do |db|
      options[:database] = db
    end

    opts.on("-h", "--help", "Show this help") do
      puts opts
      exit
    end
  end.parse!

  # Use environment variables as fallback
  options[:rails_version] ||= ENV['RAILS_VERSION'] || '8.0.4'
  options[:dummy_path] ||= ENV['DUMMY_PATH'] || 'spec/dummy'
  options[:database] ||= ENV['DATABASE_ADAPTER'] || 'postgresql'

  unless options[:rails_version] && options[:dummy_path]
    puts "Error: Missing required options"
    puts "Usage: setup-dummy-gemfile --rails-version VERSION --dummy-path PATH"
    exit 1
  end

  generator = DummyGemfileGenerator.new(**options)
  generator.generate!
end