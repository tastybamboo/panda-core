<%= render Panda::Core::Admin::ContainerComponent.new do |component| %>
  <% component.with_heading_slot(text: "Users", level: 1) do |heading| %>
    <% heading.with_button(
      text: "Invite User",
      icon: "fa-solid fa-plus",
      data: { action: "click->toggle#toggle" }
    ) %>
  <% end %>

  <!-- Search & Filters -->
  <div class="mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <%= form_with url: admin_users_path, method: :get, local: true, class: "flex flex-col gap-3 sm:flex-row sm:items-center w-full" do %>
      <div class="relative flex-1 max-w-md">
        <i class="fa-solid fa-magnifying-glass text-gray-400 text-sm pointer-events-none absolute left-3 top-1/2 -translate-y-1/2"></i>
        <%= text_field_tag :search, params[:search],
          placeholder: "Search by name or email...",
          class: "block w-full rounded-md bg-white px-3 py-1.5 pl-10 text-base text-gray-900 outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus-visible:outline-2 focus-visible:-outline-offset-2 focus-visible:outline-primary-600 sm:text-sm/6 dark:bg-white/5 dark:text-white dark:outline-white/10 dark:placeholder:text-gray-500 dark:focus:outline-primary-500" %>
      </div>

      <div class="flex gap-2">
        <%= select_tag :status,
          options_for_select([["All Statuses", ""], ["Enabled", "enabled"], ["Disabled", "disabled"], ["Invited", "invited"]], params[:status]),
          class: "w-auto rounded-md border-0 py-2 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-primary-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600" %>

        <%= select_tag :role,
          options_for_select([["All Roles", ""], ["Admin", "admin"], ["User", "user"]], params[:role]),
          class: "w-auto rounded-md border-0 py-2 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-primary-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600" %>

        <%= submit_tag "Filter", class: "rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 dark:bg-gray-700 dark:text-white dark:ring-gray-600 dark:hover:bg-gray-600 cursor-pointer" %>

        <% if params[:search].present? || params[:status].present? || params[:role].present? %>
          <%= link_to "Clear", admin_users_path, class: "rounded-md px-3 py-2 text-sm font-semibold text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300" %>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Bulk Actions Bar -->
  <div id="bulk-actions-bar" class="hidden mb-4 rounded-lg bg-primary-50 dark:bg-primary-900/20 p-3 flex items-center justify-between">
    <span class="text-sm text-primary-700 dark:text-primary-300">
      <span id="selected-count">0</span> user(s) selected
    </span>
    <div class="flex gap-2">
      <button type="button" onclick="submitBulkAction('enable')" class="rounded-md bg-green-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-green-500">Enable</button>
      <button type="button" onclick="submitBulkAction('disable')" class="rounded-md bg-red-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-red-500">Disable</button>
    </div>
  </div>

  <%= form_with url: bulk_action_admin_users_path, method: :post, id: "bulk-action-form", local: true do %>
    <%= hidden_field_tag :bulk_action, "", id: "bulk-action-field" %>

    <% if @users.any? %>
      <%= render Panda::Core::Admin::TableComponent.new(term: "user", rows: @users, icon: "users") do |table| %>
        <% table.column("", width: "5%") do |user| %>
          <input type="checkbox" name="user_ids[]" value="<%= user.id %>"
            class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 bulk-checkbox"
            onchange="updateBulkActions()">
        <% end %>

        <% table.column("User", width: "30%") do |user| %>
          <%= link_to admin_user_path(user), class: "block-link flex items-center gap-3 group" do %>
            <% url = user.avatar_url(size: :thumb) %>
            <% if url.present? %>
              <img src="<%= url %>" alt="<%= user.name %>" class="h-10 w-10 rounded-full object-cover">
            <% else %>
              <div class="h-10 w-10 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center">
                <i class="fa-solid fa-user text-gray-400 dark:text-gray-300"></i>
              </div>
            <% end %>
            <div>
              <div class="font-medium text-gray-900 dark:text-white group-hover:text-primary-600 dark:group-hover:text-primary-400"><%= user.name %></div>
              <div class="text-sm text-gray-500 dark:text-gray-400"><%= user.email %></div>
            </div>
          <% end %>
        <% end %>

        <% table.column("Role", width: "15%") do |user| %>
          <% if user.admin? %>
            <%= render Panda::Core::Admin::TagComponent.new(text: "Admin", status: :active) %>
          <% else %>
            <%= render Panda::Core::Admin::TagComponent.new(text: "User", status: :inactive) %>
          <% end %>
        <% end %>

        <% table.column("Status", width: "15%") do |user| %>
          <% if !user.enabled? %>
            <%= render Panda::Core::Admin::TagComponent.new(text: "Disabled", status: :inactive) %>
          <% elsif user.invitation_token.present? %>
            <%= render Panda::Core::Admin::TagComponent.new(text: "Invited", status: :draft) %>
          <% else %>
            <%= render Panda::Core::Admin::TagComponent.new(text: "Enabled", status: :active) %>
          <% end %>
        <% end %>

        <% table.column("Last Login", width: "20%") do |user| %>
          <% if user.last_login_at.present? %>
            <span class="text-sm text-gray-500 dark:text-gray-400" title="<%= l(user.last_login_at, format: :long) %>">
              <%= time_ago_in_words(user.last_login_at) %> ago
            </span>
          <% else %>
            <span class="text-sm text-gray-400 dark:text-gray-500">Never</span>
          <% end %>
        <% end %>
      <% end %>
    <% else %>
      <%= render Panda::Core::Admin::EmptyStateComponent.new(
        icon: "fa-solid fa-users",
        title: "No users found",
        description: params[:search].present? ? "Try adjusting your search or filter criteria." : "No users have been created yet."
      ) %>
    <% end %>
  <% end %>

  <%= render Panda::Core::Admin::PaginationComponent.new(
    page: @page, total_pages: @total_pages, total_count: @total_count,
    per_page: @per_page, item_name: "users"
  ) %>

  <!-- Invite User Slideover -->
  <% component.with_slideover_slot(title: "Invite User") do %>
    <%= panda_form_with url: invite_admin_users_path, method: :post, local: true do |f| %>
      <%= render Panda::Core::Admin::PanelComponent.new do |panel| %>
        <% panel.with_heading_slot { "User Details" } %>
        <div class="space-y-4">
          <%= f.text_field :name, required: true, placeholder: "Full name" %>
          <%= f.email_field :email, required: true, placeholder: "email@example.com" %>
          <%= f.check_box :admin, { label: "Administrator", meta: "Grant full administrative access." } %>
        </div>
      <% end %>
      <%= render Panda::Core::Admin::FormFooterComponent.new(submit_text: "Send Invitation") %>
    <% end %>
  <% end %>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    window.updateBulkActions = function() {
      var checked = document.querySelectorAll('.bulk-checkbox:checked');
      var bar = document.getElementById('bulk-actions-bar');
      var count = document.getElementById('selected-count');
      if (checked.length > 0) {
        bar.classList.remove('hidden');
        count.textContent = checked.length;
      } else {
        bar.classList.add('hidden');
      }
    };

    window.submitBulkAction = function(action) {
      document.getElementById('bulk-action-field').value = action;
      document.getElementById('bulk-action-form').submit();
    };
  });
</script>
