<%= render Panda::Core::Admin::ContainerComponent.new do |component| %>
  <% component.with_heading_slot(text: @user.name, level: 1) do |heading| %>
    <% heading.with_button(text: "Edit", href: edit_admin_user_path(@user), icon: "fa-solid fa-pencil") %>
  <% end %>

  <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
    <!-- User Info Card -->
    <div class="lg:col-span-1 space-y-6">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
        <div class="flex flex-col items-center">
          <% url = @user.avatar_url(size: :large) %>
          <% if url.present? %>
            <img src="<%= url %>" alt="<%= @user.name %>" class="h-32 w-32 rounded-full object-cover mb-4">
          <% else %>
            <div class="h-32 w-32 rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center mb-4">
              <i class="fa-solid fa-user text-4xl text-gray-400 dark:text-gray-300"></i>
            </div>
          <% end %>
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white"><%= @user.name %></h2>
          <p class="text-gray-500 dark:text-gray-400"><%= @user.email %></p>
          <div class="mt-3 flex items-center gap-2">
            <% if @user.admin? %>
              <%= render Panda::Core::Admin::TagComponent.new(text: "Administrator", status: :active) %>
            <% else %>
              <%= render Panda::Core::Admin::TagComponent.new(text: "Standard User", status: :inactive) %>
            <% end %>
            <% if !@user.enabled? %>
              <%= render Panda::Core::Admin::TagComponent.new(text: "Disabled", status: :inactive) %>
            <% elsif @user.invitation_token.present? %>
              <%= render Panda::Core::Admin::TagComponent.new(text: "Invited", status: :draft) %>
            <% end %>
          </div>
        </div>

        <!-- Enable/Disable Actions -->
        <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
          <% if @user == current_user %>
            <p class="text-sm text-gray-500 dark:text-gray-400 text-center">This is your account.</p>
          <% elsif @user.enabled? %>
            <%= button_to "Disable User", disable_admin_user_path(@user), method: :patch,
              class: "w-full rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 cursor-pointer",
              form: { data: { turbo_confirm: "Are you sure you want to disable #{@user.name}?" } } %>
          <% else %>
            <%= button_to "Enable User", enable_admin_user_path(@user), method: :patch,
              class: "w-full rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 cursor-pointer" %>
          <% end %>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 tracking-wider mb-4">Quick Stats</h3>
        <dl class="space-y-3">
          <div class="flex justify-between">
            <dt class="text-sm text-gray-600 dark:text-gray-400">Login Count</dt>
            <dd class="text-sm font-medium text-gray-900 dark:text-white"><%= @user.login_count || 0 %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-sm text-gray-600 dark:text-gray-400">Active Sessions</dt>
            <dd class="text-sm font-medium text-gray-900 dark:text-white"><%= @active_sessions_count %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-sm text-gray-600 dark:text-gray-400">Last Login</dt>
            <dd class="text-sm font-medium text-gray-900 dark:text-white">
              <% if @user.last_login_at.present? %>
                <%= time_ago_in_words(@user.last_login_at) %> ago
              <% else %>
                Never
              <% end %>
            </dd>
          </div>
          <% if @user.invited_by.present? %>
            <div class="flex justify-between">
              <dt class="text-sm text-gray-600 dark:text-gray-400">Invited By</dt>
              <dd class="text-sm font-medium text-gray-900 dark:text-white">
                <%= link_to @user.invited_by.name, admin_user_path(@user.invited_by), class: "text-primary-600 hover:text-primary-700 dark:text-primary-400" %>
              </dd>
            </div>
          <% end %>
        </dl>
      </div>
    </div>

    <!-- User Details -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Account Information -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 tracking-wider">Account Information</h3>
        </div>
        <dl class="divide-y divide-gray-200 dark:divide-gray-700">
          <div class="px-6 py-4 sm:grid sm:grid-cols-3 sm:gap-4">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Email</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-white sm:col-span-2 sm:mt-0"><%= @user.email %></dd>
          </div>
          <div class="px-6 py-4 sm:grid sm:grid-cols-3 sm:gap-4">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Member since</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-white sm:col-span-2 sm:mt-0"><%= l(@user.created_at, format: :long) %></dd>
          </div>
          <div class="px-6 py-4 sm:grid sm:grid-cols-3 sm:gap-4">
            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Last updated</dt>
            <dd class="mt-1 text-sm text-gray-900 dark:text-white sm:col-span-2 sm:mt-0"><%= l(@user.updated_at, format: :long) %></dd>
          </div>
          <% if @user.last_login_ip.present? %>
            <div class="px-6 py-4 sm:grid sm:grid-cols-3 sm:gap-4">
              <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Last login IP</dt>
              <dd class="mt-1 text-sm text-gray-900 dark:text-white sm:col-span-2 sm:mt-0"><%= @user.last_login_ip %></dd>
            </div>
          <% end %>
          <% if @user.current_theme.present? %>
            <div class="px-6 py-4 sm:grid sm:grid-cols-3 sm:gap-4">
              <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Theme preference</dt>
              <dd class="mt-1 text-sm text-gray-900 dark:text-white sm:col-span-2 sm:mt-0"><%= @user.current_theme.titleize %></dd>
            </div>
          <% end %>
        </dl>
      </div>

      <!-- Recent Activity -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
          <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 tracking-wider">Recent Activity</h3>
          <%= link_to "View All", activity_admin_user_path(@user), class: "text-sm text-primary-600 hover:text-primary-700 dark:text-primary-400" %>
        </div>
        <% if @recent_activity.any? %>
          <ul class="divide-y divide-gray-200 dark:divide-gray-700">
            <% @recent_activity.each do |activity| %>
              <li class="px-6 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="flex-shrink-0">
                    <% icon = case activity.action
                       when "login" then "fa-solid fa-right-to-bracket text-green-500"
                       when "logout" then "fa-solid fa-right-from-bracket text-gray-400"
                       when "updated_user" then "fa-solid fa-user-pen text-blue-500"
                       when "enabled_user" then "fa-solid fa-user-check text-green-500"
                       when "disabled_user" then "fa-solid fa-user-slash text-red-500"
                       when "invited_user" then "fa-solid fa-envelope text-purple-500"
                       when "revoked_session" then "fa-solid fa-ban text-red-500"
                       else "fa-solid fa-circle-info text-gray-400"
                       end %>
                    <i class="<%= icon %>"></i>
                  </div>
                  <div>
                    <span class="text-sm text-gray-900 dark:text-white"><%= activity.action.humanize %></span>
                    <% if activity.resource_type.present? %>
                      <span class="text-sm text-gray-500 dark:text-gray-400">
                        &mdash; <%= activity.resource_type.demodulize %>
                      </span>
                    <% end %>
                  </div>
                </div>
                <span class="text-xs text-gray-400 dark:text-gray-500"><%= time_ago_in_words(activity.created_at) %> ago</span>
              </li>
            <% end %>
          </ul>
        <% else %>
          <div class="px-6 py-8 text-center">
            <p class="text-sm text-gray-500 dark:text-gray-400">No activity recorded yet.</p>
          </div>
        <% end %>
      </div>

      <!-- Active Sessions -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
          <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 tracking-wider">
            Active Sessions
            <% if @active_sessions_count > 0 %>
              <span class="ml-2 inline-flex items-center rounded-full bg-green-50 px-2 py-0.5 text-xs font-medium text-green-700 dark:bg-green-500/10 dark:text-green-400"><%= @active_sessions_count %></span>
            <% end %>
          </h3>
          <%= link_to "View All Sessions", sessions_admin_user_path(@user), class: "text-sm text-primary-600 hover:text-primary-700 dark:text-primary-400" %>
        </div>
        <% if @active_sessions.any? %>
          <div class="divide-y divide-gray-200 dark:divide-gray-700">
            <% @active_sessions.each do |user_session| %>
              <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <div class="flex-shrink-0">
                    <span class="flex h-10 w-10 items-center justify-center rounded-full bg-green-100 dark:bg-green-500/10">
                      <i class="fa-solid fa-desktop text-green-600 dark:text-green-400"></i>
                    </span>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                      <% if user_session.user_agent.present? %>
                        <%= truncate(user_session.user_agent, length: 80) %>
                      <% else %>
                        Unknown browser
                      <% end %>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                      <% if user_session.ip_address.present? %>
                        IP: <%= user_session.ip_address %> &middot;
                      <% end %>
                      Last active: <%= user_session.last_active_at ? "#{time_ago_in_words(user_session.last_active_at)} ago" : "Unknown" %>
                    </div>
                  </div>
                </div>
                <% if @user != current_user %>
                  <%= button_to "Revoke",
                    revoke_session_admin_user_path(@user, session_id: user_session.id),
                    method: :delete,
                    class: "rounded-md bg-red-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-red-500 cursor-pointer",
                    form: { data: { turbo_confirm: "Revoke this session? The user will be logged out." } } %>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="px-6 py-8 text-center">
            <p class="text-sm text-gray-500 dark:text-gray-400">No active sessions.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
