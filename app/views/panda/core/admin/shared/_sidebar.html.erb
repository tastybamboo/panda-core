<nav class="flex flex-col flex-1">
  <ul role="list" class="flex flex-col flex-1">
    <a class="block p-0 mt-4 mb-4 ml-2 text-xl font-medium text-white"><%= Panda::Core.config.admin_title || "Panda Admin" %></a>
    <%
      # Get navigation items in original order for display
      nav_items = Panda::Core.config.admin_navigation_items&.call(current_user) || []

      # Helper to recursively collect all paths from nav items
      def collect_paths(items)
        items.flat_map do |item|
          paths = item[:path] ? [item[:path]] : []
          paths += collect_paths(item[:children] || [])
          paths
        end
      end

      # Find the most specific matching path by checking longest paths first
      all_paths = collect_paths(nav_items)
      active_path = all_paths
        .sort_by { |path| -path.length }
        .find { |path| request.path == path || request.path.starts_with?(path + "/") }
    %>
    <% nav_items.each_with_index do |item, index| %>
      <li>
        <%
          has_children = item[:children].present?

          # For items with children, check if any child is active
          if has_children
            is_active = item[:children].any? do |child|
              child[:path] && (request.path == child[:path] || request.path.starts_with?(child[:path] + "/"))
            end
          else
            is_active = item[:path] == active_path
          end
        %>

        <% if has_children %>
          <div class="space-y-1" data-controller="navigation-toggle">
            <button type="button"
                    data-navigation-toggle-target="button"
                    data-action="click->navigation-toggle#toggle"
                    aria-controls="sub-menu-<%= index %>"
                    aria-expanded="false"
                    class="<%= is_active ? 'bg-mid text-white' : 'text-white hover:bg-mid/60' %> transition-all group flex items-center w-full gap-x-3 py-3 px-2 mb-2 rounded-md text-base leading-6 font-normal">
              <span class="text-center w-6"><i class="<%= item[:icon] %> text-xl fa-fw"></i></span>
              <span class="flex-1 text-left"><%= item[:label] %></span>
              <i class="fa-solid fa-chevron-right text-xs transition-transform duration-150 ease-in-out"
                 data-navigation-toggle-target="icon"></i>
            </button>
            <div id="sub-menu-<%= index %>"
                 class="space-y-1 hidden"
                 style="display: none;"
                 data-navigation-toggle-target="menu">
              <% item[:children].each do |child| %>
                <%
                  child_is_active = child[:path] && (request.path == child[:path] || request.path.starts_with?(child[:path] + "/"))
                %>
                <%= link_to child[:path], class: "#{child_is_active ? 'bg-mid text-white' : 'text-white hover:bg-mid/60'} group flex items-center w-full py-2 pr-2 pl-11 rounded-md text-sm font-normal transition-all" do %>
                  <%= child[:label] %>
                <% end %>
              <% end %>
            </div>
          </div>
        <% else %>
          <%= link_to item[:path], class: "#{is_active ? "bg-mid text-white relative flex items-center transition-all py-3 px-2 mb-2 rounded-md group gap-x-3 text-base leading-6 font-normal" : "text-white hover:bg-mid/60 transition-all group flex items-center gap-x-3 py-3 px-2 mb-2 rounded-md text-base leading-6 font-normal"}" do %>
            <span class="text-center w-6"><i class="<%= item[:icon] %> text-xl fa-fw"></i></span>
            <span><%= item[:label] %></span>
          <% end %>
        <% end %>
      </li>
    <% end %>
    <li>
      <%= button_to panda_core.admin_logout_path, method: :delete, id: "logout-link", data: { turbo: false }, class: "text-white hover:bg-mid/60 transition-all group flex items-center gap-x-3 py-3 px-2 mb-2 rounded-md text-base leading-6 font-normal w-full" do %>
        <span class="text-center w-6"><i class="text-xl fa-solid fa-door-open fa-fw"></i></span>
        <span>Logout</span>
      <% end %>
    </li>
    <li class="mt-auto">
      <%
        # Check if we're in the my_profile section
        is_my_profile_active = request.path.starts_with?("#{Panda::Core.config.admin_path}/my_profile")
      %>
      <%= link_to panda_core.admin_my_profile_path, class: "#{is_my_profile_active ? 'bg-mid text-white' : 'text-white hover:bg-mid/60'} transition-all group flex items-center gap-x-3 py-3 px-2 mb-2 rounded-md text-base leading-6 font-normal w-full", title: "My Profile" do %>
        <% if current_user.avatar.attached? %>
          <span class="text-center w-6"><%= image_tag main_app.url_for(current_user.avatar), alt: current_user.name, class: "w-auto h-7 rounded-full object-cover" %></span>
        <% elsif !current_user.image_url.to_s.empty? %>
          <span class="text-center w-6"><img src="<%= current_user.image_url %>" class="w-auto h-7 rounded-full"></span>
        <% else %>
          <span class="text-center w-6"><i class="text-xl fa-solid fa-circle-user fa-fw"></i></span>
        <% end %>
        <span><%= current_user.name %></span>
      <% end %>
    </li>
    <li class="px-2 py-3">
      <span class="text-xs text-white">Panda Core v<%= Panda::Core::VERSION %></span>
    </li>
  </ul>
</nav>
