<nav <%= tag.attributes(**attrs) %>>
  <ul role="list" class="flex flex-col flex-1">
    <a class="block p-0 mt-4 mb-4 ml-2 text-xl font-medium text-white"><%= Panda::Core.config.admin_title || "Panda Admin" %></a>
    <%
      # Get navigation items from the registry (includes base lambda + registered sections/items)
      nav_items = Panda::Core::NavigationRegistry.build(@user, helpers: helpers)

      # Split into top and bottom sections
      top_items = nav_items.select { |item| item[:position] != :bottom }
      bottom_items = nav_items.select { |item| item[:position] == :bottom }

      # Helper to recursively collect all paths from nav items
      def collect_paths(items)
        items.flat_map do |item|
          paths = item[:path] ? [item[:path]] : []
          paths += collect_paths(item[:children] || [])
          paths
        end
      end

      # Find the most specific matching path by checking longest paths first
      all_paths = collect_paths(nav_items).compact
      current_path = helpers.request&.path || "/"
      active_path = all_paths
        .sort_by { |path| -path.length }
        .find { |path| current_path == path || current_path.starts_with?(path + "/") }
    %>
    <% top_items.each_with_index do |item, index| %>
      <%
        has_children = item[:children].present?

        # For items with children, check if the active path belongs to one of its children
        if has_children
          is_active = item[:children].any? { |child| child[:path] == active_path }
        else
          is_active = item[:path] == active_path
        end
      %>

      <%= render Panda::Core::Admin::Navigation::ItemComponent.new(
        label: item[:label],
        icon: item[:icon],
        path: item[:path],
        active: is_active,
        menu_id: "sub-menu-#{index}",
        target: item[:target]
      ) do |nav_item|
        if has_children
          item[:children].each do |child|
            child_is_active = child[:path] == active_path
            nav_item.with_sub_item(label: child[:label], path: child[:path], active: child_is_active, target: child[:target])
          end
        end
      end %>
    <% end %>

    <% bottom_items.each do |section| %>
      <%
        is_section_active = (section[:children] || []).any? { |child|
          child[:path] && current_path.starts_with?(child[:path])
        }
      %>
      <%= render Panda::Core::Admin::Navigation::UserMenuComponent.new(user: helpers.current_user, active: is_section_active) do |user_menu|
        (section[:children] || []).each do |item|
          # Resolve path_helper at render time if not yet resolved
          item_path = item[:path]
          if item_path.nil? && item[:path_helper]
              helper_name = item[:path_helper].to_sym
            item_path = helpers.panda_core.public_send(helper_name) if helpers.panda_core.respond_to?(helper_name)
          end

          item_active = item_path && current_path.starts_with?(item_path)
          user_menu.with_sub_item(
            label: item[:label],
            path: item_path,
            active: item_active,
            method: item[:method],
            button_options: item[:button_options] || {}
          )
        end
      end %>
    <% end %>

    <li class="px-2 py-3">
      <span class="text-xs text-white">Panda Core v<%= Panda::Core::VERSION %></span>
    </li>
  </ul>
</nav>
