<nav <%= tag.attributes(**attrs) %>>
  <ul role="list" class="flex flex-col flex-1">
    <a class="block p-0 mt-4 mb-4 ml-2 text-xl font-medium text-white"><%= Panda::Core.config.admin_title || "Panda Admin" %></a>
    <%
      # Get navigation items in original order for display
      nav_items = Panda::Core.config.admin_navigation_items&.call(@user) || []

      # Helper to recursively collect all paths from nav items
      def collect_paths(items)
        items.flat_map do |item|
          paths = item[:path] ? [item[:path]] : []
          paths += collect_paths(item[:children] || [])
          paths
        end
      end

      # Find the most specific matching path by checking longest paths first
      all_paths = collect_paths(nav_items).compact
      current_path = helpers.request&.path || "/"
      active_path = all_paths
        .sort_by { |path| -path.length }
        .find { |path| current_path == path || current_path.starts_with?(path + "/") }
    %>
    <% nav_items.each_with_index do |item, index| %>
      <%
        has_children = item[:children].present?

        # For items with children, check if the active path belongs to one of its children
        if has_children
          is_active = item[:children].any? { |child| child[:path] == active_path }
        else
          is_active = item[:path] == active_path
        end
      %>

      <%= render Panda::Core::Admin::Navigation::ItemComponent.new(
        label: item[:label],
        icon: item[:icon],
        path: item[:path],
        active: is_active,
        menu_id: "sub-menu-#{index}"
      ) do |nav_item|
        if has_children
          item[:children].each do |child|
            child_is_active = child[:path] == active_path
            nav_item.with_sub_item(label: child[:label], path: child[:path], active: child_is_active)
          end
        end
      end %>
    <% end %>

    <%
      # Check if we're in the my_profile section
      is_my_profile_active = current_path.starts_with?("#{Panda::Core.config.admin_path}/my_profile")
      is_edit_profile_active = current_path == helpers.panda_core.edit_admin_my_profile_path
      is_logins_active = current_path.starts_with?(helpers.panda_core.admin_my_profile_logins_path)
    %>
    <%= render Panda::Core::Admin::Navigation::UserMenuComponent.new(user: helpers.current_user, active: is_my_profile_active) do |user_menu|
      user_menu.with_sub_item(label: "My Profile", path: helpers.panda_core.edit_admin_my_profile_path, active: is_edit_profile_active)
      user_menu.with_sub_item(label: "Login & Security", path: helpers.panda_core.admin_my_profile_logins_path, active: is_logins_active)
      user_menu.with_sub_item(label: "Logout", path: helpers.panda_core.admin_logout_path, method: :delete, button_options: { id: "logout-link", data: { turbo: false } })
    end %>

    <li class="px-2 py-3">
      <span class="text-xs text-white">Panda Core v<%= Panda::Core::VERSION %></span>
    </li>
  </ul>
</nav>
